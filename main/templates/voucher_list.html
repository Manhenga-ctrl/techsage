{% extends "base.html" %}
{% block title %}Voucher List - HPE WiFi Portal{% endblock %}

{% block content %}
<h1>Voucher List</h1>

<!-- ===== Controls ===== -->
<div class="controls">
    <input type="text" id="searchInput" placeholder="Search Voucher Code..." onkeyup="filterTable()">

    <select id="packageFilter" onchange="filterTable()">
        <option value="">All Packages</option>
        {% for package in packages %}
            <option value="{{ package.package }}">{{ package.package }}</option>
        {% endfor %}
    </select>

    <select id="usedFilter" onchange="filterTable()">
        <option value="">All Status</option>
        <option value="Yes">Used</option>
        <option value="No">Unused</option>
    </select>
</div>

<!-- ===== Voucher Table ===== -->
<table id="voucherTable">
    <thead>
        <tr>
            <th>Voucher Code</th>
            <th>Package</th>
            <th>Created At</th>
            <th>Used</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for voucher in vouchers %}
        <tr>
            <td data-label="Voucher Code">{{ voucher.voucher_code }}</td>
            <td data-label="Package">{{ voucher.package }}</td>
            <td data-label="Created At">{{ voucher.created_at|date:"Y-m-d H:i" }}</td>
            <td data-label="Used">{{ voucher.used|yesno:"Yes,No" }}</td>
            <td data-label="Action">
                <form method="post" action="{% url 'delete_voucher' voucher.id %}">
                    {% csrf_token %}
                    <button type="submit" class="delete-btn">Delete</button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No vouchers found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    // ===== Filter Function =====
    function filterTable() {
        const search = document.getElementById("searchInput").value.toUpperCase();
        const pkg = document.getElementById("packageFilter").value;
        const used = document.getElementById("usedFilter").value;

        const rows = document.querySelectorAll("#voucherTable tbody tr");

        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            if (!cells.length) return;

            const code = cells[0].innerText.toUpperCase();
            const packageName = cells[1].innerText;
            const usedStatus = cells[3].innerText;

            let visible = true;

            if (search && !code.includes(search)) visible = false;
            if (pkg && packageName !== pkg) visible = false;
            if (used && usedStatus !== used) visible = false;

            row.style.display = visible ? "" : "none";
        });
    }
</script>
{% endblock %}
