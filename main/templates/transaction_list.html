{% extends "base.html" %}
{% block title %}Transaction List - HPE WiFi Portal{% endblock %}

{% block content %}
<h1>TRANSACTION LIST</h1>

<!-- ===== Filters ===== -->
<div class="controls">
    <input type="text" id="searchRef" placeholder="Search Reference..." onkeyup="filterTable()">
    <input type="text" id="searchMsisdn" placeholder="Search MSISDN..." onkeyup="filterTable()">

    <select id="packageFilter" onchange="filterTable()">
        <option value="">All Packages</option>
        <option value="1GB Daily - $1">1GB Daily - $1</option>
        <option value="5GB Weekly - $3">5GB Weekly - $3</option>
        <option value="10GB Monthly - $5">10GB Monthly - $5</option>
        <option value="50GB Monthly - $15">50GB Monthly - $15</option>
        <option value="100GB Monthly - $25">100GB Monthly - $25</option>
    </select>

    <select id="statusFilter" onchange="filterTable()">
        <option value="">All Status</option>
        <option value="SUCCESS">SUCCESS</option>
        <option value="PENDING">PENDING</option>
        <option value="FAILED">FAILED</option>
        <option value="NULL">NULL</option>
    </select>
</div>

<!-- ===== Table ===== -->
<table id="transactionTable">
    <thead>
        <tr>
            <th>Reference</th>
            <th>MSISDN</th>
            <th>Package</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Time</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for tx in transactions %}
        <tr>
            <td data-label="Reference">{{ tx.source_reference }}</td>
            <td data-label="MSISDN">{{ tx.customer_msisdn }}</td>
            <td data-label="Package">{{ tx.package }}</td>
            <td data-label="Amount">{{ tx.currency }} {{ tx.amount }}</td>
            <td data-label="Status" class="{% if tx.status == 'SUCCESS' %}status-success{% elif tx.status == 'PENDING' %}status-pending{% elif tx.status == 'FAILED' %}status-failed{% else %}status-null{% endif %}">
                {{ tx.status|default:"NULL" }}
            </td>
            <td data-label="Time">{{ tx.timestamp|date:"Y-m-d H:i" }}</td>
            <td data-label="Action">
                <form method="post" action="{% url 'delete_transaction' tx.source_reference %}" onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                    {% csrf_token %}
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7">No transactions found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ===== JS Filter ===== -->
<script>
function filterTable() {
    const ref = document.getElementById("searchRef").value.toUpperCase();
    const msisdn = document.getElementById("searchMsisdn").value.toUpperCase();
    const pkg = document.getElementById("packageFilter").value.toUpperCase();
    const status = document.getElementById("statusFilter").value.toUpperCase();

    document.querySelectorAll("#transactionTable tbody tr").forEach(row => {
        const r = row.cells[0].innerText.toUpperCase();
        const m = row.cells[1].innerText.toUpperCase();
        const p = row.cells[2].innerText.toUpperCase();
        const s = row.cells[4].innerText.toUpperCase();

        row.style.display =
            r.includes(ref) &&
            m.includes(msisdn) &&
            (pkg === "" || p === pkg) &&
            (status === "" || s === status)
            ? "" : "none";
    });
}
</script>
{% endblock %}
